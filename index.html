<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Freedom–Equality–Security Survey</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family:Arial, sans-serif; max-width:900px; margin:20px auto; }
    h1,h2 { text-align:center; }
    .plot-container { margin:30px 0; }
    .sliders { display:flex; flex-direction:column; gap:6px; margin-top:10px; }
    input[type=range]{ width:100%; }
    button{padding:10px 20px; margin-top:15px;}
    .center{text-align:center;}
  </style>
</head>
<body>

<h1>Freedom – Equality – Security Survey</h1>
<p>Allocate importance (must sum to 100%) among <b>Freedom</b>, <b>Equality</b>, and <b>Security</b> for both <b>Today</b> and the <b>Year 2075</b>.</p>

<!-- TODAY -->
<h2>Values Today</h2>
<div id="plot-today" class="plot-container"></div>
<div class="sliders" id="sliders-today">
  <label>Freedom: <span id="today-freedom-val">33</span></label>
  <input id="today-freedom" type="range" min="0" max="100" value="33">
  <label>Equality: <span id="today-equality-val">33</span></label>
  <input id="today-equality" type="range" min="0" max="100" value="33">
  <label>Security: <span id="today-security-val">34</span></label>
  <input id="today-security" type="range" min="0" max="100" value="34">
</div>

<hr>

<!-- 2075 -->
<h2>Values in 2075</h2>
<div id="plot-2075" class="plot-container"></div>
<div class="sliders" id="sliders-2075">
  <label>Freedom: <span id="f2075-val">33</span></label>
  <input id="f2075" type="range" min="0" max="100" value="33">
  <label>Equality: <span id="e2075-val">33</span></label>
  <input id="e2075" type="range" min="0" max="100" value="33">
  <label>Security: <span id="s2075-val">34</span></label>
  <input id="s2075" type="range" min="0" max="100" value="34">
</div>

<div class="center">
  <button id="submitBtn" disabled>Submit Responses</button>
  <p id="status"></p>
</div>

<script>
// Utility function to normalize and keep total = 1
function normalizeValues(f, e, s) {
  const t = f+e+s || 1;
  return [f/t, e/t, s/t];
}

// Initialize a ternary plot
function makePlot(divId, title, color) {
  const data = [{
    type: 'scatterternary',
    mode: 'markers',
    a: [0.33],
    b: [0.33],
    c: [0.34],
    marker: { size: 12, color: color },
    name: 'Selection'
  }];
  const layout = {
    ternary: {
      sum: 1,
      aaxis: { title: 'Freedom' },
      baxis: { title: 'Equality' },
      caxis: { title: 'Security' }
    },
    title: title,
    margin: { t: 60 }
  };
  Plotly.newPlot(divId, data, layout, { displayModeBar: false });
}

// Create both plots
makePlot('plot-today', 'Values Today', '#1f77b4');
makePlot('plot-2075', 'Values in 2075', '#d62728');

// Track user interactions
let userInteracted = { today: false, '2075': false };

// Update a plot from sliders
function updatePlotFromSliders(prefix, plotId) {
  const f = +document.getElementById(prefix+'-freedom').value;
  const e = +document.getElementById(prefix+'-equality').value;
  const s = +document.getElementById(prefix+'-security').value;
  const [nf, ne, ns] = normalizeValues(f, e, s);

  // Update text display
  document.getElementById(prefix+'-freedom-val').textContent = Math.round(nf*100);
  document.getElementById(prefix+'-equality-val').textContent = Math.round(ne*100);
  document.getElementById(prefix+'-security-val').textContent = Math.round(ns*100);

  // Update the plot marker
  Plotly.restyle(plotId, { a: [[nf]], b: [[ne]], c: [[ns]] }, [0]);

  userInteracted[prefix] = true;
  checkReady();
}

// Hook up sliders
['today','2075'].forEach(tp=>{
  ['freedom','equality','security'].forEach(v=>{
    document.getElementById(tp+'-'+v).addEventListener('input',()=>updatePlotFromSliders(tp,'plot-'+tp));
  });
  updatePlotFromSliders(tp,'plot-'+tp);
});

// Click on plot updates sliders
function handleClick(event, prefix, plotId) {
  const pt = event.points?.[0];
  if (!pt) return;
  const nf = pt.a, ne = pt.b, ns = pt.c;
  document.getElementById(prefix+'-freedom').value = Math.round(nf*100);
  document.getElementById(prefix+'-equality').value = Math.round(ne*100);
  document.getElementById(prefix+'-security').value = Math.round(ns*100);
  updatePlotFromSliders(prefix, plotId);
}

document.getElementById('plot-today').on('plotly_click', ev => handleClick(ev, 'today', 'plot-today'));
document.getElementById('plot-2075').on('plotly_click', ev => handleClick(ev, '2075', 'plot-2075'));

// Enable submit only after both plots interacted
function checkReady() {
  if (userInteracted.today && userInteracted['2075'])
    document.getElementById('submitBtn').disabled = false;
}

// --- SUBMIT FUNCTION ---
const endpoint = "https://script.google.com/macros/s/AKfycby-oWxhcSRpXkwffrnC_vvTXy7AYJRp1962j5HfEb9Pj_Ubz6FbLx-9-vZNGwhu1oPi/exec"; // Replace with your real Apps Script URL

document.getElementById('submitBtn').onclick = async ()=>{
  const getVals = (p)=> {
    const f = +document.getElementById(p+'-freedom').value;
    const e = +document.getElementById(p+'-equality').value;
    const s = +document.getElementById(p+'-security').value;
    const [nf,ne,ns]=normalizeValues(f,e,s);
    return {timepoint:p, freedom:nf, equality:ne, security:ns};
  };
  const responses = [getVals('today'), getVals('2075')];
  try {
    await fetch(endpoint,{method:'POST',body:JSON.stringify(responses)});
    status.textContent="✅ Responses submitted successfully. Thank you!";
    submitBtn.disabled=true;
  } catch(e){
    status.textContent="❌ Submission failed: "+e.message;
  }
};
</script>

</body>
</html>
