<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CivicTrust Survey</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: system-ui, Arial; max-width: 900px; margin: 30px auto; padding: 0 16px; }
  h1, h2 { text-align: center; }
  .block { margin-bottom: 40px; }
  .sliders { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; }
  label { font-weight: 500; }
  input[type=range] { width: 100%; }
  .values-display { text-align: center; margin-top: 8px; font-weight: 500; }
  .controls { text-align: center; }
  button { padding: 10px 18px; font-size: 16px; }
  #status { margin-top: 10px; color: #555; font-size: 14px; text-align: center; }
</style>
</head>
<body>
<h1>Freedom — Equality — Security Survey</h1>
<p style="text-align:center;">Adjust your priorities for <b>Today</b> and <b>Year 2075</b>. Click sliders or plots. Submit activates after both are set.</p>

<div class="block">
  <h2>Values — Today</h2>
  <div id="plot-today" style="height:360px;"></div>
  <div class="sliders" id="sliders-today"></div>
  <div class="values-display" id="values-today">Freedom: 33%, Equality: 33%, Security: 34%</div>
</div>

<hr>

<div class="block">
  <h2>Values — 2075</h2>
  <div id="plot-future" style="height:360px;"></div>
  <div class="sliders" id="sliders-future"></div>
  <div class="values-display" id="values-future">Freedom: 33%, Equality: 33%, Security: 34%</div>
</div>

<div class="controls">
  <button id="submitBtn" disabled>Submit Responses</button>
  <div id="status"></div>
</div>

<script>
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxkyonoPQeY4ppDB5yHfXtqHE795zn4uDRs0ypFfF8wiX8ueJ9v7Ls4Lvl40MpXy0ji/exec";

// ---------- Helpers ----------
function makeSliders(prefix) {
  const div = document.getElementById('sliders-' + prefix);
  ['freedom','equality','security'].forEach(v=>{
    const label = document.createElement('label');
    label.innerHTML = v.charAt(0).toUpperCase() + v.slice(1) + 
                      ': <span id="'+prefix+'-'+v+'-val">33</span>';
    const slider = document.createElement('input');
    slider.type = 'range'; slider.min = 0; slider.max = 100; slider.value = 33;
    slider.id = prefix + '-' + v;
    div.appendChild(label); div.appendChild(slider);
  });
}

function normalize(f,e,s){const t=f+e+s||1; return [f/t,e/t,s/t];}
function roundPct(x){return Math.round(x*100);}
function updateValuesDisplay(prefix, nf, ne, ns){
  document.getElementById('values-' + prefix).textContent =
    `Freedom: ${roundPct(nf)}%, Equality: ${roundPct(ne)}%, Security: ${100-(roundPct(nf)+roundPct(ne))}%`;
}

function initPlot(divId, color){
  const trace = {type:'scatterternary',mode:'markers',a:[0.33],b:[0.33],c:[0.34],
                 marker:{size:14,color:color}};
  const layout={ternary:{sum:1,aaxis:{title:'Freedom'},baxis:{title:'Equality'},caxis:{title:'Security'}},
                margin:{t:40,l:20,r:20,b:20}};
  Plotly.newPlot(divId,[trace],layout,{displayModeBar:false});
}

// Initialize sliders and plots
makeSliders('today'); makeSliders('future');
initPlot('plot-today','#1f77b4'); initPlot('plot-future','#d62728');

const interacted={today:false,future:false};
function checkSubmit(){ document.getElementById('submitBtn').disabled = !(interacted.today && interacted.future); }

function updateFromSliders(prefix, plotId){
  const f=+document.getElementById(prefix+'-freedom').value;
  const e=+document.getElementById(prefix+'-equality').value;
  const s=+document.getElementById(prefix+'-security').value;
  const [nf,ne,ns]=normalize(f,e,s);

  document.getElementById(prefix+'-freedom-val').textContent=roundPct(nf);
  document.getElementById(prefix+'-equality-val').textContent=roundPct(ne);
  document.getElementById(prefix+'-security-val').textContent=100-(roundPct(nf)+roundPct(ne));

  updateValuesDisplay(prefix, nf, ne, ns);

  Plotly.restyle(plotId,{a:[[nf]],b:[[ne]],c:[[ns]]},[0]);
  interacted[prefix]=true;
  checkSubmit();
}

// Attach slider events
['today','future'].forEach(p=>{
  ['freedom','equality','security'].forEach(v=>{
    document.getElementById(p+'-'+v).addEventListener('input',()=>updateFromSliders(p,'plot-'+p));
  });
  updateFromSliders(p,'plot-'+p);
});

// Plot click -> sliders
document.getElementById('plot-today').on('plotly_click',e=>{
  const p=e.points[0]; if(!p) return;
  document.getElementById('today-freedom').value=Math.round(p.a*100);
  document.getElementById('today-equality').value=Math.round(p.b*100);
  document.getElementById('today-security').value=Math.round(p.c*100);
  updateFromSliders('today','plot-today');
});
document.getElementById('plot-future').on('plotly_click',e=>{
  const p=e.points[0]; if(!p) return;
  document.getElementById('future-freedom').value=Math.round(p.a*100);
  document.getElementById('future-equality').value=Math.round(p.b*100);
  document.getElementById('future-security').value=Math.round(p.c*100);
  updateFromSliders('future','plot-future');
});

// ---------- Submit ----------
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const payload = ['today','future'].map(p=>{
    const f=+document.getElementById(p+'-freedom').value;
    const e=+document.getElementById(p+'-equality').value;
    const s=+document.getElementById(p+'-security').value;
    const [nf,ne,ns]=normalize(f,e,s);
    return { timepoint: p==='today'?'today':'2075', freedom:nf, equality:ne, security:ns };
  });

  document.getElementById('status').textContent='Submitting...';

  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbxkyonoPQeY4ppDB5yHfXtqHE795zn4uDRs0ypFfF8wiX8ueJ9v7Ls4Lvl40MpXy0ji/exec", {
      method:'POST',
      mode:'cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });

    const data = await res.json();

    if(data.status==='success'){
      document.getElementById('status').textContent='✅ Submitted!';
      document.getElementById('submitBtn').disabled=true;
    } else {
      document.getElementById('status').textContent='Error: '+(data.message||'Unknown error');
    }
  } catch(err){
    console.error(err);
    document.getElementById('status').textContent='Failed to submit: '+err.message;
  }
});
</script>
</body>
</html>
