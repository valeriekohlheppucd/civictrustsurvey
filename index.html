<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Freedom ‚Äî Equality ‚Äî Security Survey</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: system-ui, Arial; max-width:900px; margin:20px auto; padding:0 16px; }
h1, h2 { text-align:center; }
.sliders { display:flex; flex-direction:column; gap:6px; margin-top:10px; }
label { font-weight:600; }
input[type=range]{ width:100%; }
button{ padding:10px 18px; font-size:16px; margin-top:12px; }
#status{ text-align:center; margin-top:10px; color:#444; }
</style>
</head>
<body>
<h1>Freedom ‚Äî Equality ‚Äî Security Survey</h1>
<p style="text-align:center;">Adjust sliders or click the plots to set your priorities for <b>Today</b> and <b>Year 2075</b>. Both must be set before you can submit.</p>

<div>
  <h2>Today</h2>
  <div id="plot-today" style="height:360px;"></div>
  <div class="sliders">
    <label>Freedom: <span id="today-f-val">33</span></label><input id="today-f" type="range" min="0" max="100" value="33">
    <label>Equality: <span id="today-e-val">33</span></label><input id="today-e" type="range" min="0" max="100" value="33">
    <label>Security: <span id="today-s-val">34</span></label><input id="today-s" type="range" min="0" max="100" value="34">
  </div>
</div>

<hr>

<div>
  <h2>2075</h2>
  <div id="plot-future" style="height:360px;"></div>
  <div class="sliders">
    <label>Freedom: <span id="future-f-val">33</span></label><input id="future-f" type="range" min="0" max="100" value="33">
    <label>Equality: <span id="future-e-val">33</span></label><input id="future-e" type="range" min="0" max="100" value="33">
    <label>Security: <span id="future-s-val">34</span></label><input id="future-s" type="range" min="0" max="100" value="34">
  </div>
</div>

<div style="text-align:center;">
  <button id="submitBtn" disabled>Submit Responses</button>
  <div id="status"></div>
</div>

<script>
const ENDPOINT_URL = "YOUR_APPS_SCRIPT_URL_HERE"; // üëà REPLACE THIS

function norm(f,e,s){ const sum=f+e+s||1; return [f/sum, e/sum, s/sum]; }

function plotInit(div,color){
  Plotly.newPlot(div,[{
    type:'scatterternary',mode:'markers',
    a:[0.33], b:[0.33], c:[0.34],
    marker:{size:12,color:color}
  }],{
    ternary:{ sum:1,
      aaxis:{title:'Freedom'},
      baxis:{title:'Equality'},
      caxis:{title:'Security'}
    },
    margin:{t:40,l:10,r:10,b:10}
  },{displayModeBar:false});
}
plotInit('plot-today','#1f77b4');
plotInit('plot-future','#d62728');

const interacted = { today:false, future:false };
function checkSubmit(){
  document.getElementById('submitBtn').disabled = !(interacted.today && interacted.future);
}

function update(prefix){
  const f=+document.getElementById(prefix+'-f').value;
  const e=+document.getElementById(prefix+'-e').value;
  const s=+document.getElementById(prefix+'-s').value;
  const [nf,ne,ns]=norm(f,e,s);
  document.getElementById(prefix+'-f-val').textContent=Math.round(nf*100);
  document.getElementById(prefix+'-e-val').textContent=Math.round(ne*100);
  document.getElementById(prefix+'-s-val').textContent=100-(Math.round(nf*100)+Math.round(ne*100));
  Plotly.restyle('plot-'+(prefix==='today'?'today':'future'),
    {'a':[[nf]],'b':[[ne]],'c':[[ns]]});
  interacted[prefix]=true;
  checkSubmit();
}

// slider listeners
['today','future'].forEach(p=>{
  ['f','e','s'].forEach(v=>{
    document.getElementById(p+'-'+v).addEventListener('input',()=>update(p));
  });
  update(p);
});

// click to update sliders
function clickHandler(prefix){
  const plot=document.getElementById('plot-'+(prefix==='today'?'today':'future'));
  plot.on('plotly_click',ev=>{
    const pt=ev.points[0]; if(!pt)return;
    document.getElementById(prefix+'-f').value=Math.round(pt.a*100);
    document.getElementById(prefix+'-e').value=Math.round(pt.b*100);
    document.getElementById(prefix+'-s').value=Math.round(pt.c*100);
    update(prefix);
  });
}
clickHandler('today'); clickHandler('future');

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  document.getElementById('status').textContent='Submitting...';
  const today=norm(+today_f.value,+today_e.value,+today_s.value);
  const future=norm(+future_f.value,+future_e.value,+future_s.value);
  const payload=[
    {timepoint:'today', freedom:today[0], equality:today[1], security:today[2]},
    {timepoint:'2075', freedom:future[0], equality:future[1], security:future[2]}
  ];
  try{
    const r=await fetch(https://script.google.com/macros/s/AKfycbwXz7NFWbLa2tTYr4lhNl3gatsmrG-ZONT2NlyE7iHDGbQxSnuLwoN6XojGVpsV45fd/exec,{
      method:'POST',mode:'cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const txt=await r.text();
    if(!r.ok || !txt.includes('OK')) throw new Error(txt);
    document.getElementById('status').textContent='‚úÖ Submitted!';
    document.getElementById('submitBtn').disabled=true;
  }catch(err){
    document.getElementById('status').textContent='‚ùå Submission failed: '+err.message;
    checkSubmit();
  }
});
</script>
</body>
</html>
