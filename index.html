<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Freedom • Equality • Security Survey</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 30px auto; padding: 0 16px; }
    h1, h2 { text-align: center; }
    .block { margin-bottom: 40px; }
    .sliders { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; }
    label { font-weight: 500; }
    input[type=range] { width: 100%; }
    .controls { text-align: center; }
    button { padding: 10px 18px; font-size: 16px; }
    #status { margin-top: 10px; color: #555; font-size: 14px; text-align: center; }
  </style>
</head>
<body>
  <h1>Freedom — Equality — Security Survey</h1>
  <p style="text-align:center;">Adjust your priorities for <b>Today</b> and <b>Year 2075</b>.  
  Click in each plot or move the sliders. Submit activates after both are set.</p>

  <div class="block">
    <h2>Values — Today</h2>
    <div id="plot-today" style="height:360px;"></div>
    <div class="sliders" id="sliders-today"></div>
  </div>

  <hr>

  <div class="block">
    <h2>Values — 2075</h2>
    <div id="plot-future" style="height:360px;"></div>
    <div class="sliders" id="sliders-future"></div>
  </div>

  <div class="controls">
    <button id="submitBtn" disabled>Submit Responses</button>
    <div id="status"></div>
  </div>

<script>
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbyPlr5QcD64KhAfB0MohuDNI2mnnFWZZ3sdUoEggfR8PnywduAo3WLiQCQtVM2NeA8-/exec";

// ---------- helpers ----------
function makeSliders(prefix) {
  const div = document.getElementById('sliders-' + prefix);
  ['freedom','equality','security'].forEach((v,i)=>{
    const label = document.createElement('label');
    label.innerHTML = v.charAt(0).toUpperCase() + v.slice(1) + 
                      ': <span id="'+prefix+'-'+v+'-val">33</span>';
    const slider = document.createElement('input');
    slider.type = 'range'; slider.min = 0; slider.max = 100; slider.value = 33;
    slider.id = prefix + '-' + v;
    div.appendChild(label); div.appendChild(slider);
  });
}
makeSliders('today'); makeSliders('future');

function normalize(f,e,s){const t=f+e+s||1;return [f/t,e/t,s/t];}
function roundPct(x){return Math.round(x*100);}

function initPlot(divId, color){
  const trace = {type:'scatterternary',mode:'markers',a:[0.33],b:[0.33],c:[0.34],
                 marker:{size:14,color:color}};
  const layout={ternary:{sum:1,aaxis:{title:'Freedom'},baxis:{title:'Equality'},caxis:{title:'Security'}},
                margin:{t:40,l:20,r:20,b:20}};
  Plotly.newPlot(divId,[trace],layout,{displayModeBar:false});
}
initPlot('plot-today','#1f77b4');
initPlot('plot-future','#d62728');

const interacted={today:false,future:false};
function checkSubmit(){
  document.getElementById('submitBtn').disabled = !(interacted.today && interacted.future);
}

// ---------- sliders -> plot ----------
function updateFromSliders(prefix, plotId){
  const f=+document.getElementById(prefix+'-freedom').value;
  const e=+document.getElementById(prefix+'-equality').value;
  const s=+document.getElementById(prefix+'-security').value;
  const [nf,ne,ns]=normalize(f,e,s);
  document.getElementById(prefix+'-freedom-val').textContent=roundPct(nf);
  document.getElementById(prefix+'-equality-val').textContent=roundPct(ne);
  document.getElementById(prefix+'-security-val').textContent=100-(roundPct(nf)+roundPct(ne));
  Plotly.restyle(plotId,{a:[[nf]],b:[[ne]],c:[[ns]]},[0]);
  interacted[prefix]=true;
  checkSubmit();
}

['today','future'].forEach(p=>{
  ['freedom','equality','security'].forEach(v=>{
    document.getElementById(p+'-'+v).addEventListener('input',()=>updateFromSliders(p,'plot-'+p));
  });
  updateFromSliders(p,'plot-'+p);
});

// ---------- plot -> sliders ----------
document.getElementById('plot-today').on('plotly_click',e=>{
  const p=e.points[0]; if(!p) return;
  document.getElementById('today-freedom').value=Math.round(p.a*100);
  document.getElementById('today-equality').value=Math.round(p.b*100);
  document.getElementById('today-security').value=Math.round(p.c*100);
  updateFromSliders('today','plot-today');
});
document.getElementById('plot-future').on('plotly_click',e=>{
  const p=e.points[0]; if(!p) return;
  document.getElementById('future-freedom').value=Math.round(p.a*100);
  document.getElementById('future-equality').value=Math.round(p.b*100);
  document.getElementById('future-security').value=Math.round(p.c*100);
  updateFromSliders('future','plot-future');
});

// ---------- submit ----------
document.getElementById('submitBtn').addEventListener('click',async()=>{
  document.getElementById('status').textContent='Submitting...';
  const collect=p=>{
    const f=+document.getElementById(p+'-freedom').value;
    const e=+document.getElementById(p+'-equality').value;
    const s=+document.getElementById(p+'-security').value;
    const [nf,ne,ns]=normalize(f,e,s);
    return {timepoint:p==='today'?'today':'2075',freedom:nf,equality:ne,security:ns};
  };
  const payload=[collect('today'),collect('future')];
  try{
    const res=await fetch(https://script.google.com/macros/s/AKfycbwXz7NFWbLa2tTYr4lhNl3gatsmrG-ZONT2NlyE7iHDGbQxSnuLwoN6XojGVpsV45fd/exec,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok) throw new Error(await res.text());
    document.getElementById('status').textContent='✅ Submitted!';
    document.getElementById('submitBtn').disabled=true;
  }catch(err){
    document.getElementById('status').textContent='Error: '+err.message;
    checkSubmit();
  }
});
</script>
</body>
</html>
